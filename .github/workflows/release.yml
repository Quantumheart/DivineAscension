name: Release

on:
  push:
    branches: [main, master]

# Prevent concurrent releases
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  # Job 1: Check if we need to create a version bump PR
  version-bump:
    runs-on: ubuntu-latest
    # Skip if this is already a release commit (PR was merged)
    if: "!startsWith(github.event.head_commit.message, 'chore(release):')"

    permissions:
      contents: write
      pull-requests: write

    outputs:
      bumped: ${{ steps.version.outputs.bumped }}
      new_version: ${{ steps.version.outputs.new_version }}
      pr_created: ${{ steps.create_pr.outputs.pull-request-number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: current
        run: |
          VERSION=$(jq -r '.version' DivineAscension/modinfo.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Determine version bump from commits
        id: bump
        run: |
          # Get the last tag, or use initial commit if no tags exist
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "No previous tags found, analyzing all commits"
            COMMITS=$(git log --pretty=format:"%s" HEAD)
          else
            echo "Analyzing commits since $LAST_TAG"
            COMMITS=$(git log --pretty=format:"%s" ${LAST_TAG}..HEAD)
          fi

          echo "Commits to analyze:"
          echo "$COMMITS"
          echo ""

          # Determine bump type from conventional commits
          BUMP_TYPE="none"

          if echo "$COMMITS" | grep -qE "^[a-z]+(\([^)]+\))?!:|BREAKING CHANGE"; then
            BUMP_TYPE="major"
            echo "Found breaking change commits"
          elif echo "$COMMITS" | grep -qE "^feat(\([^)]+\))?:"; then
            BUMP_TYPE="minor"
            echo "Found feature commits"
          elif echo "$COMMITS" | grep -qE "^fix(\([^)]+\))?:"; then
            BUMP_TYPE="patch"
            echo "Found fix commits"
          else
            echo "No conventional commits requiring version bump"
          fi

          echo "type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "Bump type: $BUMP_TYPE"

      - name: Calculate new version
        id: version
        run: |
          BUMP_TYPE="${{ steps.bump.outputs.type }}"
          CURRENT="${{ steps.current.outputs.version }}"

          if [ "$BUMP_TYPE" == "none" ]; then
            echo "new_version=$CURRENT" >> $GITHUB_OUTPUT
            echo "bumped=false" >> $GITHUB_OUTPUT
            echo "No version bump needed"
            exit 0
          fi

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "$BUMP_TYPE" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "Version bump: $CURRENT â†’ $NEW_VERSION ($BUMP_TYPE)"

      - name: Check for existing release PR
        id: check_pr
        if: steps.version.outputs.bumped == 'true'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          BRANCH_NAME="release/v${NEW_VERSION}"

          # Check if branch already exists
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release branch $BRANCH_NAME already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update version files
        if: steps.version.outputs.bumped == 'true' && steps.check_pr.outputs.exists != 'true'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          echo "Updating modinfo.json to $NEW_VERSION"
          jq ".version = \"$NEW_VERSION\"" DivineAscension/modinfo.json > tmp.json
          mv tmp.json DivineAscension/modinfo.json

          ASSEMBLY_FILE="DivineAscension/Properties/AssemblyInfo.cs"
          if [ -f "$ASSEMBLY_FILE" ]; then
            echo "Updating $ASSEMBLY_FILE"
            sed -i "s/AssemblyVersion(\"[^\"]*\")/AssemblyVersion(\"$NEW_VERSION.0\")/" "$ASSEMBLY_FILE"
            sed -i "s/AssemblyFileVersion(\"[^\"]*\")/AssemblyFileVersion(\"$NEW_VERSION.0\")/" "$ASSEMBLY_FILE"
          fi

      - name: Create Pull Request
        id: create_pr
        if: steps.version.outputs.bumped == 'true' && steps.check_pr.outputs.exists != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(release): bump version to ${{ steps.version.outputs.new_version }}"
          branch: "release/v${{ steps.version.outputs.new_version }}"
          delete-branch: true
          title: "chore(release): bump version to ${{ steps.version.outputs.new_version }}"
          body: |
            ## Automated Release PR

            This PR bumps the version to **${{ steps.version.outputs.new_version }}** based on conventional commits.

            ### Changes
            - Updated `modinfo.json` version
            - Updated `AssemblyInfo.cs` version (if present)

            ### What happens when merged
            - A GitHub Release will be created automatically
            - The mod will be packaged and attached to the release

            ---
            *This PR was created automatically by the release workflow.*
          labels: |
            release
            automated

      - name: Summary
        run: |
          echo "## Version Bump Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.version.outputs.bumped }}" == "true" ]; then
            if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
              echo "Release PR already exists for v${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            elif [ -n "${{ steps.create_pr.outputs.pull-request-number }}" ]; then
              echo "Created Release PR #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "[View PR](${{ steps.create_pr.outputs.pull-request-url }})" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No version bump needed - no feat/fix commits since last release" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Create release when version bump PR is merged
  release:
    runs-on: ubuntu-latest
    # Only run when a release commit is pushed (version bump PR merged)
    if: "startsWith(github.event.head_commit.message, 'chore(release):')"

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Get version from modinfo.json
        id: version
        run: |
          VERSION=$(jq -r '.version' DivineAscension/modinfo.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Check if release already exists
        id: release_check
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v$VERSION"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG already exists, skipping release"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Will create release $TAG"
          fi

      - name: Restore dependencies
        if: steps.release_check.outputs.exists == 'false'
        run: dotnet restore DivineAscension.sln

      - name: Build Release
        if: steps.release_check.outputs.exists == 'false'
        run: dotnet build DivineAscension.sln -c Release --no-restore

      - name: Run tests
        if: steps.release_check.outputs.exists == 'false'
        run: dotnet test DivineAscension.sln -c Release --no-build --verbosity normal
        continue-on-error: true  # Don't block release on test issues with stubs

      - name: Package mod
        if: steps.release_check.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          MOD_DIR="DivineAscension/bin/Release/Mods/mod"
          PACKAGE_NAME="DivineAscension-${VERSION}.zip"

          echo "Creating package: $PACKAGE_NAME"

          cd "$MOD_DIR"
          zip -r "../../../../$PACKAGE_NAME" .

          echo "package_name=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "package_path=$PACKAGE_NAME" >> $GITHUB_ENV

      - name: Generate release notes
        if: steps.release_check.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi

          FEATURES=$(git log $RANGE --pretty=format:"- %s (%h)" --no-merges | grep -E "^- feat" || true)
          FIXES=$(git log $RANGE --pretty=format:"- %s (%h)" --no-merges | grep -E "^- fix" || true)
          OTHERS=$(git log $RANGE --pretty=format:"- %s (%h)" --no-merges | grep -vE "^- (feat|fix|chore\(release\)|Merge)" || true)

          echo "## What's Changed" > release_notes.md

          if [ -n "$FEATURES" ]; then
            echo "" >> release_notes.md
            echo "### Features" >> release_notes.md
            echo "$FEATURES" >> release_notes.md
          fi

          if [ -n "$FIXES" ]; then
            echo "" >> release_notes.md
            echo "### Bug Fixes" >> release_notes.md
            echo "$FIXES" >> release_notes.md
          fi

          if [ -n "$OTHERS" ]; then
            echo "" >> release_notes.md
            echo "### Other Changes" >> release_notes.md
            echo "$OTHERS" >> release_notes.md
          fi

          if [ -n "$PREV_TAG" ]; then
            echo "" >> release_notes.md
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${VERSION}" >> release_notes.md
          fi

          echo "Release notes:"
          cat release_notes.md

      - name: Create GitHub Release
        if: steps.release_check.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Divine Ascension v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: ${{ env.package_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.release_check.outputs.exists }}" == "false" ]; then
            echo "**Released:** [v$VERSION](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Package:** ${{ env.package_name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "Release v$VERSION already exists - skipped" >> $GITHUB_STEP_SUMMARY
          fi
