# Divine Ascension: Server Configuration & Protection System (Using ConfigLib)

## Overview

Implementing a Tier 1 configuration system using **ConfigLib** (by maltiez2) and essential cooldown/rate limiting to make Divine Ascension production-ready for server hosting.

**Key Decision:** Leverage ConfigLib instead of building custom configuration system.

## What This Adds

### 1. Tier 1 Configuration System (via ConfigLib)
**Server-tunable balance settings:**
- **Favor System**: Passive generation rate (0.5/hr default), death penalty (50 default), rank multipliers (1.0-1.5x), prestige multipliers (1.0-1.5x)
- **Progression**: Favor rank thresholds (Initiate=0 → Avatar=10000), Prestige rank thresholds (Fledgling=0 → Mythic=50000)
- **PvP**: Kill rewards (10 favor, 75 prestige), death penalty (50), war multipliers (1.5x)

**Interface (provided by ConfigLib):**
- YAML config file (`ModConfig/divineascension.yaml`) - Auto-generated, user-editable
- In-game GUI - Built-in ImGui interface (via ConfigLib)
- Automatic hot-reload when file changes
- Client-server sync (server config pushed to clients)

**Benefits of ConfigLib:**
- ✅ No need to build JSON serialization/validation
- ✅ No need to build in-game GUI
- ✅ No need to build hot-reload system
- ✅ No need to build client-server sync
- ✅ Proven, tested library used by other VS mods
- ✅ YAML format more user-friendly than JSON
- ✅ Built-in validation, sliders, dropdowns, comments

### 2. Cooldown & Rate Limiting System
**Operations protected:**
- Religion deletion: 60s (prevents rage-quit grief)
- Member kick: 5s (prevents mass kicks)
- Player ban: 10s (prevents mass bans)
- Invite send: 2s (prevents invite spam)
- Religion creation: 300s (prevents spam creation)
- Diplomacy proposal: 30s (prevents proposal spam)
- War declaration: 60s (prevents war flip-flopping)

**Features:**
- Admin bypass (Privilege.root automatically skips cooldowns)
- Configurable durations via `/da config cooldown`
- Clear error messages with remaining time
- Memory-only (resets on server restart, appropriate for short cooldowns)

## Architecture

### Configuration System Design (Using ConfigLib)

**ConfigLib Integration:**
- **Dependency**: Add ConfigLib as optional dependency in modinfo.json
- **Integration Method**: `RegisterCustomManagedConfig()` - POCO-based configuration
- **File Location**: `ModConfig/divineascension.yaml` (auto-generated by ConfigLib)
- **GUI**: Built-in ImGui configuration window (accessed via game menu)

**Config Data Class** (new file):
```
/Configuration/GameBalanceConfig.cs          (~150 lines - simpler than custom system!)
├── Favor System
│   ├── PassiveFavorRate (float, 0.0-10.0, default 0.5)
│   ├── DeathPenalty (int, 0-1000, default 50)
│   ├── InitiateMultiplier, DiscipleMultiplier, etc. (float, 0.1-5.0)
│   └── FledglingMultiplier, EstablishedMultiplier, etc. (float, 0.1-5.0)
├── Progression
│   ├── DiscipleThreshold, ZealotThreshold, etc. (int, 0-1000000)
│   └── EstablishedThreshold, RenownedThreshold, etc. (int, 0-1000000)
└── PvP
    ├── KillFavorReward, KillPrestigeReward (int, 0-1000)
    ├── DeathPenalty (int, 0-1000)
    └── WarFavorMultiplier, WarPrestigeMultiplier (float, 0.1-5.0)
```

**Integration Pattern:**
```csharp
// In DivineAscensionModSystem.Start()
if (api.ModLoader.IsModEnabled("configlib"))
{
    ConfigLibModSystem configLib = api.ModLoader.GetModSystem<ConfigLibModSystem>();

    // Register POCO config object
    configLib.RegisterCustomManagedConfig(
        domain: "divineascension",
        configObject: _gameBalanceConfig,
        onSettingChanged: (settingCode) => OnConfigChanged(settingCode)
    );
}
```

**ConfigLib Handles Automatically:**
- ✅ YAML file generation with default values
- ✅ File reading/writing with validation
- ✅ In-game GUI with sliders, inputs, checkboxes
- ✅ Hot-reload when file changes
- ✅ Client-server synchronization
- ✅ Field-based mapping (YAML names match C# property names)

**Validation & Safety:**
- ConfigLib validates ranges specified in C# attributes
- We define min/max ranges on properties
- Thresholds validated to be ascending in config class constructor
- If ConfigLib not installed, uses hardcoded defaults (graceful degradation)

### Cooldown System Design

**Core Classes** (new files):
```
/Systems/CooldownManager.cs                  (350 lines)
├── Per-player cooldown tracking (Dictionary<UID, Dictionary<Type, DateTime>>)
├── CanPerformOperation() - Check if allowed
├── RecordOperation() - Record timestamp
├── Admin bypass logic (checks Privilege.root)
├── Auto-cleanup every 5 minutes
└── Thread-safe (lock for concurrent requests)

/Models/Enum/CooldownType.cs                 (15 lines)
└── Enum: ReligionDeletion, KickMember, BanPlayer, SendInvite,
          ReligionCreation, DiplomacyProposal, WarDeclaration

/Utilities/CooldownTimeFormatter.cs          (30 lines)
└── Format remaining time (e.g., "2 minutes and 15 seconds")
```

**Integration Pattern:**
```csharp
// Before operation
if (!_cooldownManager.CanPerformOperation(playerUID, CooldownType.KickMember, out var remaining))
{
    return Error(_cooldownManager.GetCooldownErrorMessage(CooldownType.KickMember, remaining));
}

// Execute operation...

// After successful operation
_cooldownManager.RecordOperation(playerUID, CooldownType.KickMember);
```

## Implementation Steps

### Phase 1: Add ConfigLib Dependency & Create Config Class
1. **Add ConfigLib dependency to `modinfo.json`** (optional dependency)
2. **Create `GameBalanceConfig.cs`** - Simple POCO class with public properties
   - All Tier 1 settings as public properties with default values
   - No ProtoBuf attributes needed (ConfigLib handles serialization)
   - Add property validation in constructor (ascending thresholds)
3. **Add ConfigLib reference to project** - Either NuGet or local DLL reference

### Phase 2: Register Config with ConfigLib
4. **Modify `DivineAscensionModSystem.Start()`**:
   - Check if ConfigLib is installed: `api.ModLoader.IsModEnabled("configlib")`
   - Get ConfigLibModSystem: `api.ModLoader.GetModSystem<ConfigLibModSystem>()`
   - Call `RegisterCustomManagedConfig()` with domain, config object, and callbacks
   - Store reference to config object for managers to access
5. **Handle ConfigLib absence gracefully**:
   - If ConfigLib not installed, use hardcoded defaults
   - Log notification about optional ConfigLib support

### Phase 3: Inject Config Into Systems
6. **Modify `DivineAscensionSystemInitializer.cs`**:
   - Pass `GameBalanceConfig` reference to managers
   - Inject into `FavorSystem`, `ReligionPrestigeManager`, `PvPManager` constructors
7. **Modify `FavorSystem.cs`**:
   - Replace `BASE_FAVOR_PER_HOUR` (0.5f) with `config.PassiveFavorRate`
   - Replace rank/prestige multipliers with config property values
   - Replace `DEATH_PENALTY_FAVOR` with `config.DeathPenalty`
8. **Modify `PlayerProgressionData.cs`**:
   - Inject thresholds into `CalculateRank()` from config
9. **Modify `ReligionPrestigeManager.cs`**:
   - Replace hardcoded thresholds with config property values
10. **Modify `PvPManager.cs`**:
    - Replace `BASE_FAVOR_REWARD`, `BASE_PRESTIGE_REWARD`, `DEATH_PENALTY_FAVOR`
    - Replace war multipliers with config property values

### Phase 4: Cooldown System Foundation
11. **Create `CooldownManager.cs`** with core tracking and validation logic
12. **Create `CooldownType.cs`** enum with 7 operation types
13. **Create `CooldownTimeFormatter.cs`** for user-friendly time display
14. **Modify `ModConfigData.cs`** to add cooldown configuration (durations + enabled toggle)
15. **Initialize `CooldownManager`** in `DivineAscensionSystemInitializer.cs` (early, after LocalizationService)

### Phase 5: Integrate Cooldowns Into Commands
16. **Modify `ReligionCommands.cs`** - Inject `CooldownManager`, protect 5 operations:
    - `OnDisbandReligion` → CooldownType.ReligionDeletion (60s)
    - `OnKickPlayer` → CooldownType.KickMember (5s)
    - `OnBanPlayer` → CooldownType.BanPlayer (10s)
    - `OnInvitePlayer` → CooldownType.SendInvite (2s)
    - `OnCreateReligion` → CooldownType.ReligionCreation (300s)
17. **Modify `CivilizationCommands.cs`** - Inject `CooldownManager`, protect:
    - `OnInviteReligion` → CooldownType.SendInvite (2s)
18. **Modify `DiplomacyManager.cs`** - Inject `CooldownManager`, protect:
    - `ProposeRelationship` → CooldownType.DiplomacyProposal (30s)
    - `DeclareWar` → CooldownType.WarDeclaration (60s)

### Phase 6: Network Handler Integration
19. **Modify `ReligionNetworkHandler.cs`** - Add cooldown checks for action requests
20. **Modify `CivilizationNetworkHandler.cs`** - Add cooldown checks for action requests

### Phase 7: Admin Tools & Localization
21. **Extend `ConfigCommands.cs`** with `/da config cooldown` subcommands:
    - `status` - Show all cooldown durations
    - `set <operation> <seconds>` - Modify duration
    - `enable` / `disable` - Toggle cooldowns globally
22. **Add localization keys** to `LocalizationKeys.cs` for cooldown errors
23. **Add translations** to `assets/divineascension/lang/en.json`

### Phase 8: Testing
24. **Create `CooldownManagerTests.cs`** - Unit tests (9 test cases)
25. **Create `ReligionCommandsWithCooldownTests.cs`** - Integration tests (4 test cases)
26. **Manual testing**: Verify ConfigLib integration, config GUI, hot-reload, cooldown enforcement

## Critical Files

### New Files (4 total - Much simpler with ConfigLib!)
```
DivineAscension/Configuration/GameBalanceConfig.cs               (~150 lines - simple POCO)
DivineAscension/Systems/CooldownManager.cs                       (350 lines)
DivineAscension/Models/Enum/CooldownType.cs                      (15 lines)
DivineAscension/Utilities/CooldownTimeFormatter.cs               (30 lines)
```

### Modified Files (12 total)
```
DivineAscension/modinfo.json                                     (+3 lines - add ConfigLib dependency)
DivineAscension/DivineAscensionModSystem.cs                      (+20 lines - ConfigLib registration)
DivineAscension/Data/ModConfigData.cs                            (+30 lines - cooldown config)
DivineAscension/Systems/DivineAscensionSystemInitializer.cs      (+40 lines - pass config reference)
DivineAscension/Systems/FavorSystem.cs                           (~120 lines modified)
DivineAscension/Systems/PlayerProgressionData.cs                 (~40 lines modified)
DivineAscension/Systems/ReligionPrestigeManager.cs               (~60 lines modified)
DivineAscension/Systems/PvPManager.cs                            (~80 lines modified)
DivineAscension/Commands/ConfigCommands.cs                       (+100 lines - cooldown commands only)
DivineAscension/Commands/ReligionCommands.cs                     (+100 lines - cooldown integration)
DivineAscension/Commands/CivilizationCommands.cs                 (+30 lines - cooldown integration)
DivineAscension/Systems/DiplomacyManager.cs                      (+50 lines - cooldown integration)
DivineAscension/Systems/Networking/Server/ReligionNetworkHandler.cs  (+60 lines)
```

### Test Files (2 total)
```
DivineAscension.Tests/Systems/CooldownManagerTests.cs            (450 lines)
DivineAscension.Tests/Commands/ReligionCommandsWithCooldownTests.cs  (350 lines)
```

### Generated Files (by ConfigLib)
```
ModConfig/divineascension.yaml                                   (auto-generated by ConfigLib)
```

**Total Impact:** 4 new files, 12 modified files, 2 test files (~1,100 new lines, ~580 modified lines)
**Savings vs Custom:** ~1,400 lines of code NOT written (JSON/validation/GUI/hot-reload system)

## Configuration Access

### Game Balance Configuration (via ConfigLib GUI)

**Access:** Press ESC → Click "Mod Settings" → Select "Divine Ascension"

**Features provided by ConfigLib:**
- Slider widgets for numeric values (favor rates, thresholds, multipliers)
- Input fields with validation (clamped to safe ranges)
- Reset to defaults button
- Save button (writes to YAML file)
- Reload button (reads from YAML file)
- In-game tooltips with descriptions

**Manual editing:** `ModConfig/divineascension.yaml` (YAML format, human-readable)

**Example YAML:**
```yaml
version: 1
# Passive favor generation per in-game hour
passive-favor-rate: 0.5 # from 0 to 10
# Favor lost on death
death-penalty: 50 # from 0 to 1000
# Disciple rank threshold (lifetime favor)
disciple-threshold: 500 # from 0 to 1000000
# ... etc
```

### Cooldown Commands (Admin Only)
```bash
# View all cooldown durations
/da config cooldown status

# Modify specific cooldown
/da config cooldown set religionDeletion 120
/da config cooldown set kickMember 10

# Toggle cooldowns
/da config cooldown disable  # For events/testing
/da config cooldown enable   # Re-enable
```

## Verification Plan

### Configuration System Testing (ConfigLib)
1. **Fresh World**: Start server with ConfigLib installed, verify YAML file auto-generated at `ModConfig/divineascension.yaml`
2. **GUI Access**: Press ESC → Mod Settings → Divine Ascension, verify GUI opens with all settings
3. **GUI Editing**: Change passive favor rate via slider, click Save, verify change reflected in game
4. **Hot-Reload**: Edit YAML file directly, click Reload in GUI, verify new values applied
5. **Validation**: Try to set invalid values (e.g., negative favor rate), verify clamped to safe ranges
6. **ConfigLib Absence**: Start server WITHOUT ConfigLib, verify mod uses hardcoded defaults and logs message
7. **Gameplay**: Award favor, verify multipliers work; rank up, verify thresholds correct; PvP kill, verify rewards
8. **Client-Server Sync**: Join server as client, verify server config synced to client (client sees server's config in GUI)

### Cooldown System Testing
1. **Spam Prevention**: Try rapid kicks/bans, verify cooldown enforced with clear error messages
2. **Admin Bypass**: Login as admin, verify cooldowns skipped automatically
3. **Time Display**: Trigger cooldown, verify remaining time formatted correctly ("5 seconds", "2 minutes and 30 seconds")
4. **Configuration**: Change cooldown duration via command, verify new duration applied
5. **Disable Toggle**: Disable cooldowns, verify all operations allowed; re-enable, verify enforcement resumes
6. **Network Handlers**: Test UI-driven operations (kick from ImGui), verify cooldowns enforced
7. **Edge Cases**: Test cooldown expiry boundary, test concurrent operations from different players

### Integration Testing
1. **Existing Worlds**: Load world with existing data, verify migration to new config system
2. **Backward Compatibility**: Verify existing hardcoded defaults match new config defaults
3. **Performance**: Simulate 50+ concurrent players, verify no lag from cooldown checks
4. **Religion Lifecycle**: Create religion → invite members → kick member (cooldown) → disband (cooldown), verify all steps work
5. **Diplomacy Flow**: Create civilization → propose NAP (cooldown) → declare war (cooldown), verify cooldowns respected

## Security Impact

### Vulnerabilities Addressed (From Audit)
✅ **CRITICAL: Religion deletion grief** - 60s cooldown prevents instant rage-quit destruction
✅ **CRITICAL: Mass kick attacks** - 5s cooldown limits rapid member removal
✅ **CRITICAL: Mass ban attacks** - 10s cooldown limits rapid bans
✅ **HIGH: Invite spam** - 2s cooldown prevents flooding
✅ **HIGH: Religion spam** - 300s cooldown prevents creation spam
✅ **MEDIUM: Proposal spam** - 30s cooldown prevents diplomatic flooding
✅ **MEDIUM: War declaration spam** - 60s cooldown prevents flip-flopping

### Remaining Gaps (Out of Scope)
- Persistent audit logging (requires new database system)
- Rollback/recovery mechanisms (requires data versioning)
- PvP anti-farming (requires kill tracking database)
- Confirmation dialogs (requires UI/network changes)

## Performance Characteristics

### Configuration System (ConfigLib)
- **Load time**: <10ms (YAML parse by ConfigLib)
- **Memory**: ~2KB per world (config object)
- **Hot-reload**: <1ms (ConfigLib event firing)
- **Read overhead**: O(1) property access (no performance impact)
- **GUI overhead**: Only when opened by player

### Cooldown System
- **Memory**: ~150 bytes/player × 7 operations = ~1KB/player (100 players = 100KB)
- **Check time**: O(1) dictionary lookup (~microseconds)
- **Cleanup time**: O(n×m) where n=players, m=operations (runs every 5 min, negligible)
- **Thread safety**: Lock-based (safe for concurrent network requests)

## Migration & Backward Compatibility

### Existing Worlds
- ConfigLib checks for existing YAML file, creates if missing
- First run generates YAML with default values matching current hardcoded constants
- Zero gameplay impact if using defaults
- Cooldowns start fresh (no historical data needed)

### ConfigLib Installation
- If ConfigLib not installed: mod uses hardcoded defaults, logs notification
- If ConfigLib installed later: YAML file generated, previous behavior preserved
- No data migration needed (ConfigLib handles versioning)

### Player Impact
- **Zero gameplay changes** if using defaults
- Admins can tune balance post-deployment without code changes
- Cooldowns add slight friction but improve server health long-term

## Future Enhancements (Not Included)

### Tier 2 Configuration (Next Phase)
- Favor tracker rewards (mining tiers, hunting weights, crafting bonuses)
- Quality/automation multipliers (helve hammer penalty, ore quality)
- Civilization limits (size, invite expiry)
- Activity log storage limits

### Advanced Cooldowns
- Tiered cooldowns by rank (Avatar gets 50% reduction)
- Grace period (3 rapid operations allowed, then cooldown)
- UI cooldown indicators (countdown timers on buttons)
- Persistent cooldowns across restarts

### Admin Oversight Tools
- Dashboard UI (system health, recent actions)
- Player/religion search commands
- Comprehensive audit logging
- Bulk operations (mass unlock, cleanup tools)

## Notes

- **ConfigLib is optional**: If not installed, mod uses hardcoded defaults (graceful degradation)
- **ConfigLib reference**: Need to add DLL reference or NuGet package for development
- **YAML vs properties**: YAML field names derived from C# property names (snake-case conversion)
- **Initialization order**: GameBalanceConfig must be available before managers initialize
- **Cooldown system independent**: Cooldowns work regardless of ConfigLib presence
- **Admin bypass automatic**: CooldownManager checks Privilege.root internally
- **Thread-safe design**: CooldownManager uses proper locking for concurrent access
- **Validation**: ConfigLib validates ranges, we validate threshold ordering in constructor
- **Localization ready**: All error messages use LocalizationService for multi-language support

## ConfigLib Resources

- **Repository**: https://github.com/maltiez2/vsmod_configlib
- **Mod Page**: https://mods.vintagestory.at/configlib
- **Installation**: Download from Mod DB or build from source
- **License**: CC0-1.0 (public domain)

## GitHub Issue Breakdown

See separate document: `docs/topics/planning/feature/configuration-github-issues.md`
